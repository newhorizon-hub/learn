<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operazioni con i Segmenti</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    header h1 {
      color: #2c3e50;
      font-size: 1.8rem;
      margin-bottom: 10px;
    }

    header p {
      color: #7f8c8d;
      font-size: 0.95rem;
    }

    /* Progress Bar */
    .progress-container {
      background: white;
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .progress-bar::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 4px;
      background: #e0e0e0;
      transform: translateY(-50%);
      z-index: 0;
    }

    .progress-step {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
      color: #999;
      z-index: 1;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .progress-step.active {
      background: #3498db;
      color: white;
      transform: scale(1.1);
    }

    .progress-step.completed {
      background: #27ae60;
      color: white;
    }

    /* Phases */
    .phase {
      display: none;
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      animation: fadeIn 0.4s ease;
    }

    .phase.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .phase-title {
      font-size: 1.4rem;
      color: #2c3e50;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .phase-title .icon {
      font-size: 1.5rem;
    }

    .phase-subtitle {
      color: #7f8c8d;
      margin-bottom: 20px;
      font-size: 0.95rem;
    }

    /* Interactive Cards - Phase 1 & 2 */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .concept-card {
      background: linear-gradient(145deg, #f8f9fa, #fff);
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .concept-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }

    .concept-card.explored {
      border-color: #27ae60;
      background: linear-gradient(145deg, #e8f5e9, #fff);
    }

    .concept-card.explored::after {
      content: '‚úì';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #27ae60;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .card-icon {
      width: 45px;
      height: 45px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }

    .card-icon.blue { background: #e3f2fd; }
    .card-icon.green { background: #e8f5e9; }
    .card-icon.orange { background: #fff3e0; }
    .card-icon.purple { background: #f3e5f5; }

    .card-title {
      font-weight: 600;
      color: #2c3e50;
      font-size: 1.1rem;
    }

    .card-preview {
      color: #7f8c8d;
      font-size: 0.9rem;
    }

    .card-content {
      display: none;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px dashed #e0e0e0;
    }

    .concept-card.expanded .card-content {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 500px; }
    }

    .card-content p {
      margin-bottom: 12px;
      color: #444;
    }

    .formula-box {
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      padding: 12px 15px;
      border-radius: 0 8px 8px 0;
      margin: 12px 0;
      font-size: 1.1rem;
      text-align: center;
    }

    .segment-visual {
      background: #fafafa;
      border-radius: 8px;
      padding: 15px;
      margin: 12px 0;
      text-align: center;
    }

    .segment-visual svg {
      max-width: 100%;
      height: auto;
    }

    /* Phase 3 - Key Concepts */
    .key-concepts {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .key-card {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .key-card.explored {
      border-color: #27ae60;
    }

    .key-card-header {
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
    }

    .key-card-header:hover {
      background: #f5f5f5;
    }

    .key-card-title {
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .key-card-arrow {
      transition: transform 0.3s ease;
      color: #7f8c8d;
    }

    .key-card.expanded .key-card-arrow {
      transform: rotate(180deg);
    }

    .key-card-content {
      display: none;
      padding: 0 20px 20px;
      background: white;
    }

    .key-card.expanded .key-card-content {
      display: block;
    }

    /* Phase 4 - Quiz */
    .quiz-section {
      margin-bottom: 20px;
    }

    .quiz-category {
      margin-bottom: 25px;
    }

    .quiz-category-title {
      font-weight: 600;
      color: #3498db;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }

    .quiz-question {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 15px;
    }

    .question-text {
      font-weight: 500;
      margin-bottom: 12px;
      color: #2c3e50;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .option-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .option-label:hover {
      border-color: #3498db;
      background: #f0f7ff;
    }

    .option-label input {
      display: none;
    }

    .option-label .radio-custom {
      width: 20px;
      height: 20px;
      border: 2px solid #bbb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .option-label input:checked + .radio-custom {
      border-color: #3498db;
      background: #3498db;
    }

    .option-label input:checked + .radio-custom::after {
      content: '';
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }

    .option-label.correct {
      border-color: #27ae60;
      background: #e8f5e9;
    }

    .option-label.incorrect {
      border-color: #e74c3c;
      background: #ffebee;
    }

    .option-label.disabled {
      pointer-events: none;
      opacity: 0.8;
    }

    .feedback {
      display: none;
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .feedback.correct {
      display: block;
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #27ae60;
    }

    .feedback.incorrect {
      display: block;
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #e74c3c;
    }

    /* Phase 5 - Review */
    .review-section {
      margin-bottom: 20px;
    }

    .review-area {
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .review-area.needs-review {
      background: #fff8e1;
      border: 2px solid #ffc107;
    }

    .review-area.mastered {
      background: #e8f5e9;
      border: 2px solid #27ae60;
    }

    .review-area-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .review-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .review-badge.needs-review {
      background: #ffc107;
      color: #333;
    }

    .review-badge.mastered {
      background: #27ae60;
      color: white;
    }

    .review-area h4 {
      color: #2c3e50;
    }

    .review-content {
      color: #444;
    }

    .review-content p {
      margin-bottom: 10px;
    }

    /* Buttons */
    .btn {
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-primary:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-success:hover {
      background: #219a52;
    }

    .btn-secondary {
      background: #ecf0f1;
      color: #2c3e50;
    }

    .btn-secondary:hover {
      background: #dfe6e9;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .instruction {
      background: #e3f2fd;
      border-left: 4px solid #3498db;
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
      color: #1565c0;
      font-size: 0.95rem;
    }

    .score-display {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      color: white;
      margin-bottom: 20px;
    }

    .score-display .score {
      font-size: 2.5rem;
      font-weight: bold;
    }

    .score-display .score-label {
      font-size: 1rem;
      opacity: 0.9;
    }

    .missing-warning {
      background: #fff3e0;
      border: 1px solid #ff9800;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 15px;
      color: #e65100;
      display: none;
    }

    /* Print styles */
    @media print {
      body {
        background: white;
        padding: 10px;
      }

      header, .progress-container, .btn-group, .instruction {
        display: none !important;
      }

      [id^="phase"] {
        display: none !important;
      }

      #phase5 {
        display: block !important;
        box-shadow: none;
        padding: 0;
      }

      .review-area {
        break-inside: avoid;
        page-break-inside: avoid;
      }

      .score-display {
        background: #f0f0f0 !important;
        color: #333 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }

    /* Responsive */
    @media (max-width: 600px) {
      body {
        padding: 12px;
      }

      header h1 {
        font-size: 1.4rem;
      }

      .phase {
        padding: 18px;
      }

      .cards-grid {
        grid-template-columns: 1fr;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .btn-group {
        flex-direction: column;
      }

      .progress-step {
        width: 30px;
        height: 30px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìê Operazioni con i Segmenti</h1>
      <p>Scopri come sommare, sottrarre e calcolare multipli e frazioni di segmenti</p>
    </header>

    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-step active" data-phase="1">1</div>
        <div class="progress-step" data-phase="2">2</div>
        <div class="progress-step" data-phase="3">3</div>
        <div class="progress-step" data-phase="4">4</div>
        <div class="progress-step" data-phase="5">5</div>
      </div>
    </div>

    <!-- FASE 1: Somma e Differenza -->
    <div id="phase1" class="phase active">
      <h2 class="phase-title"><span class="icon">‚ûï‚ûñ</span> Somma e Differenza di Segmenti</h2>
      <p class="phase-subtitle">Fase 1 di 5</p>
      
      <div class="instruction">
        üëÜ Clicca su ogni scheda per scoprire definizione, formula e rappresentazione grafica.
      </div>

      <div class="cards-grid">
        <!-- Card Somma -->
        <div class="concept-card" data-card="somma">
          <div class="card-header">
            <div class="card-icon blue">‚ûï</div>
            <div>
              <div class="card-title">Somma di segmenti</div>
              <div class="card-preview">Clicca per esplorare</div>
            </div>
          </div>
          <div class="card-content">
            <p>La <strong>somma</strong> di due segmenti <span class="math">\overline{AB}</span> e <span class="math">\overline{CD}</span> √® un nuovo segmento la cui lunghezza √® uguale alla somma delle lunghezze dei due segmenti.</p>
            <div class="formula-box">
              <span class="math">\overline{EF} = \overline{AB} + \overline{CD}</span>
            </div>
            <div class="segment-visual">
              <svg viewBox="0 0 400 80" width="100%" height="80">
                <line x1="20" y1="30" x2="100" y2="30" stroke="#3498db" stroke-width="4"/>
                <circle cx="20" cy="30" r="4" fill="#3498db"/>
                <circle cx="100" cy="30" r="4" fill="#3498db"/>
                <text x="60" y="20" text-anchor="middle" font-size="12" fill="#333">AB</text>
                
                <text x="120" y="35" font-size="18" fill="#333">+</text>
                
                <line x1="140" y1="30" x2="200" y2="30" stroke="#e74c3c" stroke-width="4"/>
                <circle cx="140" cy="30" r="4" fill="#e74c3c"/>
                <circle cx="200" cy="30" r="4" fill="#e74c3c"/>
                <text x="170" y="20" text-anchor="middle" font-size="12" fill="#333">CD</text>
                
                <text x="220" y="35" font-size="18" fill="#333">=</text>
                
                <line x1="240" y1="30" x2="380" y2="30" stroke="#9b59b6" stroke-width="4"/>
                <circle cx="240" cy="30" r="4" fill="#9b59b6"/>
                <circle cx="380" cy="30" r="4" fill="#9b59b6"/>
                <text x="310" y="20" text-anchor="middle" font-size="12" fill="#333">EF = AB + CD</text>
              </svg>
            </div>
            <p>Per sommare due segmenti, si dispongono in modo che siano <strong>consecutivi</strong> (un estremo in comune) e si considera il segmento che va dal primo all'ultimo estremo.</p>
          </div>
        </div>

        <!-- Card Differenza -->
        <div class="concept-card" data-card="differenza">
          <div class="card-header">
            <div class="card-icon green">‚ûñ</div>
            <div>
              <div class="card-title">Differenza di segmenti</div>
              <div class="card-preview">Clicca per esplorare</div>
            </div>
          </div>
          <div class="card-content">
            <p>La <strong>differenza</strong> tra due segmenti <span class="math">\overline{AB}</span> e <span class="math">\overline{CD}</span> (con <span class="math">\overline{AB} > \overline{CD}</span>) √® un nuovo segmento la cui lunghezza √® uguale alla differenza delle lunghezze.</p>
            <div class="formula-box">
              <span class="math">\overline{EF} = \overline{AB} - \overline{CD}</span>
            </div>
            <div class="segment-visual">
              <svg viewBox="0 0 400 80" width="100%" height="80">
                <line x1="20" y1="30" x2="140" y2="30" stroke="#3498db" stroke-width="4"/>
                <circle cx="20" cy="30" r="4" fill="#3498db"/>
                <circle cx="140" cy="30" r="4" fill="#3498db"/>
                <text x="80" y="20" text-anchor="middle" font-size="12" fill="#333">AB</text>
                
                <text x="160" y="35" font-size="18" fill="#333">‚àí</text>
                
                <line x1="180" y1="30" x2="240" y2="30" stroke="#e74c3c" stroke-width="4"/>
                <circle cx="180" cy="30" r="4" fill="#e74c3c"/>
                <circle cx="240" cy="30" r="4" fill="#e74c3c"/>
                <text x="210" y="20" text-anchor="middle" font-size="12" fill="#333">CD</text>
                
                <text x="260" y="35" font-size="18" fill="#333">=</text>
                
                <line x1="280" y1="30" x2="360" y2="30" stroke="#9b59b6" stroke-width="4"/>
                <circle cx="280" cy="30" r="4" fill="#9b59b6"/>
                <circle cx="360" cy="30" r="4" fill="#9b59b6"/>
                <text x="320" y="20" text-anchor="middle" font-size="12" fill="#333">EF</text>
              </svg>
            </div>
            <p>‚ö†Ô∏è <strong>Attenzione:</strong> la differenza si pu√≤ calcolare solo se il primo segmento √® <strong>maggiore</strong> del secondo!</p>
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="btn-phase1" disabled>Prosegui ‚ûî</button>
      </div>
    </div>

    <!-- FASE 2: Multiplo e Sottomultiplo -->
    <div id="phase2" class="phase">
      <h2 class="phase-title"><span class="icon">‚úñÔ∏è‚ûó</span> Multiplo e Sottomultiplo</h2>
      <p class="phase-subtitle">Fase 2 di 5</p>
      
      <div class="instruction">
        üëÜ Clicca su ogni scheda per scoprire definizione, formula e rappresentazione grafica.
      </div>

      <div class="cards-grid">
        <!-- Card Multiplo -->
        <div class="concept-card" data-card="multiplo">
          <div class="card-header">
            <div class="card-icon orange">‚úñÔ∏è</div>
            <div>
              <div class="card-title">Multiplo di un segmento</div>
              <div class="card-preview">Clicca per esplorare</div>
            </div>
          </div>
          <div class="card-content">
            <p>Il <strong>multiplo</strong> di un segmento <span class="math">\overline{AB}</span> secondo un numero <span class="math">n</span> √® un nuovo segmento ottenuto ripetendo <span class="math">\overline{AB}</span> per <span class="math">n</span> volte consecutive.</p>
            <div class="formula-box">
              <span class="math">\overline{CD} = n \cdot \overline{AB}</span>
            </div>
            <div class="segment-visual">
              <svg viewBox="0 0 400 100" width="100%" height="100">
                <line x1="20" y1="25" x2="80" y2="25" stroke="#3498db" stroke-width="4"/>
                <circle cx="20" cy="25" r="4" fill="#3498db"/>
                <circle cx="80" cy="25" r="4" fill="#3498db"/>
                <text x="50" y="15" text-anchor="middle" font-size="12" fill="#333">AB</text>
                
                <text x="100" y="30" font-size="14" fill="#333">√ó 3 =</text>
                
                <line x1="140" y1="25" x2="200" y2="25" stroke="#9b59b6" stroke-width="4"/>
                <line x1="200" y1="25" x2="260" y2="25" stroke="#9b59b6" stroke-width="4"/>
                <line x1="260" y1="25" x2="320" y2="25" stroke="#9b59b6" stroke-width="4"/>
                <circle cx="140" cy="25" r="4" fill="#9b59b6"/>
                <circle cx="200" cy="25" r="4" fill="#9b59b6"/>
                <circle cx="260" cy="25" r="4" fill="#9b59b6"/>
                <circle cx="320" cy="25" r="4" fill="#9b59b6"/>
                
                <path d="M 140 45 Q 230 70 320 45" stroke="#666" stroke-width="1" fill="none"/>
                <text x="230" y="80" text-anchor="middle" font-size="12" fill="#333">CD = 3 ¬∑ AB</text>
              </svg>
            </div>
            <p>Esempio: il <strong>triplo</strong> di un segmento si ottiene ripetendolo 3 volte, il <strong>doppio</strong> ripetendolo 2 volte.</p>
          </div>
        </div>

        <!-- Card Sottomultiplo -->
        <div class="concept-card" data-card="sottomultiplo">
          <div class="card-header">
            <div class="card-icon purple">‚ûó</div>
            <div>
              <div class="card-title">Sottomultiplo (frazione)</div>
              <div class="card-preview">Clicca per esplorare</div>
            </div>
          </div>
          <div class="card-content">
            <p>Il <strong>sottomultiplo</strong> (o <strong>frazione</strong>) di un segmento <span class="math">\overline{AB}</span> √® una delle <span class="math">n</span> parti uguali in cui il segmento viene diviso.</p>
            <div class="formula-box">
              <span class="math">\overline{CD} = \frac{m}{n} \cdot \overline{AB}</span>
            </div>
            <div class="segment-visual">
              <svg viewBox="0 0 400 90" width="100%" height="90">
                <line x1="40" y1="30" x2="360" y2="30" stroke="#3498db" stroke-width="4"/>
                <circle cx="40" cy="30" r="4" fill="#3498db"/>
                <circle cx="360" cy="30" r="4" fill="#3498db"/>
                <text x="30" y="25" text-anchor="middle" font-size="11" fill="#333">A</text>
                <text x="370" y="25" text-anchor="middle" font-size="11" fill="#333">B</text>
                
                <line x1="120" y1="22" x2="120" y2="38" stroke="#666" stroke-width="2"/>
                <line x1="200" y1="22" x2="200" y2="38" stroke="#666" stroke-width="2"/>
                <line x1="280" y1="22" x2="280" y2="38" stroke="#666" stroke-width="2"/>
                
                <line x1="40" y1="55" x2="280" y2="55" stroke="#e74c3c" stroke-width="5"/>
                <text x="160" y="75" text-anchor="middle" font-size="12" fill="#333">3/4 di AB</text>
              </svg>
            </div>
            <p>Per calcolare <span class="math">\frac{3}{4}</span> di un segmento: prima lo <strong>dividi</strong> in 4 parti uguali, poi ne <strong>prendi</strong> 3.</p>
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToPhase(1)">‚Üê Indietro</button>
        <button class="btn btn-primary" id="btn-phase2" disabled>Prosegui ‚ûî</button>
      </div>
    </div>

    <!-- FASE 3: Concetti Chiave -->
    <div id="phase3" class="phase">
      <h2 class="phase-title"><span class="icon">‚≠ê</span> Concetti Chiave</h2>
      <p class="phase-subtitle">Fase 3 di 5</p>
      
      <div class="instruction">
        üëÜ Espandi ogni sezione per approfondire i concetti fondamentali.
      </div>

      <div class="key-concepts">
        <!-- Formule Operative -->
        <div class="key-card" data-key="formule">
          <div class="key-card-header">
            <span class="key-card-title">üìù Riepilogo delle Formule</span>
            <span class="key-card-arrow">‚ñº</span>
          </div>
          <div class="key-card-content">
            <div class="formula-box"><span class="math">\overline{EF} = \overline{AB} + \overline{CD}</span> ‚Äî Somma</div>
            <div class="formula-box"><span class="math">\overline{EF} = \overline{AB} - \overline{CD}</span> ‚Äî Differenza (con <span class="math">\overline{AB} > \overline{CD}</span>)</div>
            <div class="formula-box"><span class="math">\overline{CD} = n \cdot \overline{AB}</span> ‚Äî Multiplo</div>
            <div class="formula-box"><span class="math">\overline{CD} = \frac{m}{n} \cdot \overline{AB} = \overline{AB} : n \cdot m</span> ‚Äî Sottomultiplo</div>
          </div>
        </div>

        <!-- Congruenza -->
        <div class="key-card" data-key="congruenza">
          <div class="key-card-header">
            <span class="key-card-title">üîÑ Confronto e Congruenza</span>
            <span class="key-card-arrow">‚ñº</span>
          </div>
          <div class="key-card-content">
            <p>Due segmenti si dicono <strong>congruenti</strong> (simbolo ‚âÖ) quando hanno la <strong>stessa lunghezza</strong>.</p>
            <p>Per confrontare due segmenti si <strong>sovrappongono</strong> facendo coincidere un estremo: se anche l'altro estremo coincide, i segmenti sono congruenti.</p>
            <div class="segment-visual">
              <svg viewBox="0 0 300 60" width="100%" height="60">
                <line x1="20" y1="20" x2="120" y2="20" stroke="#3498db" stroke-width="4"/>
                <line x1="20" y1="35" x2="120" y2="35" stroke="#e74c3c" stroke-width="4"/>
                <text x="70" y="55" text-anchor="middle" font-size="12" fill="#27ae60">AB ‚âÖ CD</text>
                
                <line x1="180" y1="20" x2="280" y2="20" stroke="#3498db" stroke-width="4"/>
                <line x1="180" y1="35" x2="250" y2="35" stroke="#f39c12" stroke-width="4"/>
                <text x="220" y="55" text-anchor="middle" font-size="12" fill="#333">EF > GH</text>
              </svg>
            </div>
            <p>‚ö†Ô∏è Due segmenti congruenti hanno la stessa misura, ma <strong>non necessariamente</strong> la stessa posizione.</p>
          </div>
        </div>

        <!-- Errori Comuni -->
        <div class="key-card" data-key="errori">
          <div class="key-card-header">
            <span class="key-card-title">‚ö†Ô∏è Errori da Evitare</span>
            <span class="key-card-arrow">‚ñº</span>
          </div>
          <div class="key-card-content">
            <p><strong>1.</strong> La differenza si pu√≤ calcolare <strong>solo</strong> se il primo segmento √® maggiore del secondo.</p>
            <p><strong>2.</strong> Per calcolare la frazione di un segmento: <strong>prima</strong> si divide per il denominatore, <strong>poi</strong> si moltiplica per il numeratore.</p>
            <p><strong>3.</strong> Congruente non significa "nella stessa posizione": due segmenti possono essere congruenti anche se sono in punti diversi del piano.</p>
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToPhase(2)">‚Üê Indietro</button>
        <button class="btn btn-primary" id="btn-phase3" disabled>Vai alla Verifica ‚ûî</button>
      </div>
    </div>

    <!-- FASE 4: Quiz -->
    <div id="phase4" class="phase">
      <h2 class="phase-title"><span class="icon">‚úçÔ∏è</span> Verifica</h2>
      <p class="phase-subtitle">Fase 4 di 5</p>
      
      <div class="instruction">
        Rispondi a tutte le domande, poi clicca "Verifica Risposte".
      </div>

      <div class="missing-warning" id="missing-warning">
        ‚ö†Ô∏è Alcune domande non hanno risposta. Completa tutte le domande prima di verificare.
      </div>

      <div class="quiz-section">
        <!-- Categoria: Somma e Differenza -->
        <div class="quiz-category" data-category="somma-differenza">
          <div class="quiz-category-title">Somma e Differenza</div>
          
          <div class="quiz-question" data-question="q1" data-correct="b">
            <div class="question-text">1. Se <span class="math">\overline{AB} = 8</span> cm e <span class="math">\overline{CD} = 5</span> cm, quanto misura <span class="math">\overline{AB} + \overline{CD}</span>?</div>
            <div class="options-list">
              <label class="option-label"><input type="radio" name="q1" value="a"><span class="radio-custom"></span> 3 cm</label>
              <label class="option-label"><input type="radio" name="q1" value="b"><span class="radio-custom"></span> 13 cm</label>
              <label class="option-label"><input type="radio" name="q1" value="c"><span class="radio-custom"></span> 40 cm</label>
              <label class="option-label"><input type="radio" name="q1" value="d"><span class="radio-custom"></span> 1,6 cm</label>
            </div>
            <div class="feedback" data-feedback="q1">La somma di due segmenti si calcola sommando le loro lunghezze: 8 + 5 = 13 cm.</div>
          </div>

          <div class="quiz-question" data-question="q2" data-correct="c">
            <div class="question-text">2. Quale condizione √® necessaria per calcolare la differenza tra due segmenti?</div>
            <div class="options-list">
              <label class="option-label"><input type="radio" name="q2" value="a"><span class="radio-custom"></span> I segmenti devono essere paralleli</label>
              <label class="option-label"><input type="radio" name="q2" value="b"><span class="radio-custom"></span> I segmenti devono essere congruenti</label>
              <label class="option-label"><input type="radio" name="q2" value="c"><span class="radio-custom"></span> Il primo segmento deve essere maggiore del secondo</label>
              <label class="option-label"><input type="radio" name="q2" value="d"><span class="radio-custom"></span> Non serve nessuna condizione</label>
            </div>
            <div class="feedback" data-feedback="q2">La differenza tra due segmenti esiste solo se il minuendo (primo segmento) √® maggiore del sottraendo (secondo segmento).</div>
          </div>

          <div class="quiz-question" data-question="q3" data-correct="a">
            <div class="question-text">3. Se <span class="math">\overline{AB} = 12</span> cm e <span class="math">\overline{CD} = 7</span> cm, quanto vale <span class="math">\overline{AB} - \overline{CD}</span>?</div>
            <div class="options-list">
              <label class="option-label"><input type="radio" name="q3" value="a"><span class="radio-custom"></span> 5 cm</label>
              <label class="option-label"><input type="radio" name="q3" value="b"><span class="radio-custom"></span> 19 cm</label>
              <label class="option-label"><input type="radio" name="q3" value="c"><span class="radio-custom"></span> 84 cm</label>
              <label class="option-label"><input type="radio" name="q3" value="d"><span class="radio-custom"></span> ‚àí5 cm</label>
            </div>
            <div class="feedback" data-feedback="q3">La differenza si calcola sottraendo: 12 ‚àí 7 = 5 cm.</div>
          </div>
        </div>

        <!-- Categoria: Multiplo e Sottomultiplo -->
        <div class="quiz-category" data-category="multiplo-sottomultiplo">
          <div class="quiz-category-title">Multiplo e Sottomultiplo</div>
          
          <div class="quiz-question" data-question="q4" data-correct="b">
            <div class="question-text">4. Se <span class="math">\overline{AB} = 6</span> cm, quanto misura il triplo di <span class="math">\overline{AB}</span>?</div>
            <div class="options-list">
              <label class="option-label"><input type="radio" name="q4" value="a"><span class="radio-custom"></span> 9 cm</label>
              <label class="option-label"><input type="radio" name="q4" value="b"><span class="radio-custom"></span> 18 cm</label>
              <label class="option-label"><input type="radio" name="q4" value="c"><span class="radio-custom"></span> 2 cm</label>
              <label class="option-label"><input type="radio" name="q4" value="d"><span class="radio-custom"></span> 12 cm</label>
            </div>
            <div class="feedback" data-feedback="q4">Il triplo si ottiene moltiplicando per 3: 6 √ó 3 = 18 cm.</div>
          </div>

          <div class="quiz-question" data-question="q5" data-correct="c">
            <div class="question-text">5. Per calcolare <span class="math">\frac{2}{5}</span> di un segmento, qual √® la procedura corretta?</div>
            <div class="options-list">
              <label class="option-label"><input type="radio" name="q5" value="a"><span class="radio-custom"></span> Dividere per 2 e moltiplicare per 5</label>
              <label class="option-label"><input type="radio" name="q5" value="b"><span class="radio-custom"></span> Moltiplicare per 2 e per 5</label>
              <label class="option-label"><input type="radio" name="q5" value="c"><span class="radio-custom"></span> Dividere per 5 e moltiplicare per 2</label>
              <label class="option-label"><input type="radio" name="q5" value="d"><span class="radio-custom"></span> Sottrarre 2 e aggiungere 5</label>
            </div>
            <div class="feedback" data-feedback="q5">Per calcolare una frazione di un segmento: prima si divide per il denominatore (5), poi si moltiplica per il numeratore (2).</div>
          </div>

          <div class="quiz-question" data-question="q6" data-correct="d">
            <div class="question-text">6. Se <span class="math">\overline{AB} = 20</span> cm, quanto misura <span class="math">\frac{3}{4}</span> di <span class="math">\overline{AB}</span>?</div>
            <div class="options-list">
              <label class="option-label"><input type="radio" name="q6" value="a"><span class="radio-custom"></span> 5 cm</label>
              <label class="option-label"><input type="radio" name="q6" value="b"><span class="radio-custom"></span> 12 cm</label>
              <label class="option-label"><input type="radio" name="q6" value="c"><span class="radio-custom"></span> 80 cm</label>
              <label class="option-label"><input type="radio" name="q6" value="d"><span class="radio-custom"></span> 15 cm</label>
            </div>
            <div class="feedback" data-feedback="q6">Si calcola: 20 : 4 = 5, poi 5 √ó 3 = 15 cm.</div>
          </div>
        </div>

        <!-- Categoria: Congruenza -->
        <div class="quiz-category" data-category="congruenza">
          <div class="quiz-category-title">Congruenza e Confronto</div>
          
          <div class="quiz-question" data-question="q7" data-correct="b">
            <div class="question-text">7. Due segmenti congruenti hanno necessariamente:</div>
            <div class="options-list">
              <label class="option-label"><input type="radio" name="q7" value="a"><span class="radio-custom"></span> La stessa posizione</label>
              <label class="option-label"><input type="radio" name="q7" value="b"><span class="radio-custom"></span> La stessa lunghezza</label>
              <label class="option-label"><input type="radio" name="q7" value="c"><span class="radio-custom"></span> Gli stessi estremi</label>
              <label class="option-label"><input type="radio" name="q7" value="d"><span class="radio-custom"></span> La stessa direzione</label>
            </div>
            <div class="feedback" data-feedback="q7">Due segmenti sono congruenti se e solo se hanno la stessa lunghezza. Possono trovarsi in posizioni diverse.</div>
          </div>

          <div class="quiz-question" data-question="q8" data-correct="a">
            <div class="question-text">8. Qual √® il simbolo della congruenza?</div>
            <div class="options-list">
              <label class="option-label"><input type="radio" name="q8" value="a"><span class="radio-custom"></span> ‚âÖ</label>
              <label class="option-label"><input type="radio" name="q8" value="b"><span class="radio-custom"></span> =</label>
              <label class="option-label"><input type="radio" name="q8" value="c"><span class="radio-custom"></span> ‚âà</label>
              <label class="option-label"><input type="radio" name="q8" value="d"><span class="radio-custom"></span> ‚â°</label>
            </div>
            <div class="feedback" data-feedback="q8">Il simbolo ‚âÖ indica la congruenza tra figure geometriche, inclusi i segmenti.</div>
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToPhase(3)">‚Üê Indietro</button>
        <button class="btn btn-success" id="btn-verify" onclick="verifyQuiz()">Verifica Risposte ‚úì</button>
        <button class="btn btn-primary" id="btn-phase4" style="display:none;">Vai al Ripasso ‚ûî</button>
      </div>
    </div>

    <!-- FASE 5: Ripasso -->
    <div id="phase5" class="phase">
      <h2 class="phase-title"><span class="icon">üìö</span> Ripasso Personalizzato</h2>
      <p class="phase-subtitle">Fase 5 di 5</p>

      <div class="score-display" id="score-display">
        <div class="score" id="final-score">0/8</div>
        <div class="score-label">Risposte corrette</div>
      </div>

      <div class="review-section" id="review-content">
        <!-- Populated dynamically -->
      </div>

      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToPhase(4)">‚Üê Rivedi Errori</button>
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Stampa Ripasso</button>
        <button class="btn btn-success" onclick="restart()">üîÑ Ricomincia</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentPhase = 1;
    const explored = {
      phase1: new Set(),
      phase2: new Set(),
      phase3: new Set()
    };
    const required = {
      phase1: ['somma', 'differenza'],
      phase2: ['multiplo', 'sottomultiplo'],
      phase3: ['formule', 'congruenza', 'errori']
    };
    let quizResults = {};

    // Initialize KaTeX
    document.addEventListener('DOMContentLoaded', () => {
      renderMath();
      setupCardListeners();
      setupKeyCardListeners();
    });

    function renderMath() {
      document.querySelectorAll('.math').forEach(el => {
        katex.render(el.textContent, el, { throwOnError: false });
      });
    }

    // Card interactions - Phase 1 & 2
    function setupCardListeners() {
      document.querySelectorAll('.concept-card').forEach(card => {
        card.addEventListener('click', () => {
          const cardId = card.dataset.card;
          card.classList.toggle('expanded');
          
          if (!card.classList.contains('explored')) {
            card.classList.add('explored');
            
            // Determine which phase
            if (['somma', 'differenza'].includes(cardId)) {
              explored.phase1.add(cardId);
              checkPhaseCompletion(1);
            } else if (['multiplo', 'sottomultiplo'].includes(cardId)) {
              explored.phase2.add(cardId);
              checkPhaseCompletion(2);
            }
          }
        });
      });
    }

    // Key card interactions - Phase 3
    function setupKeyCardListeners() {
      document.querySelectorAll('.key-card').forEach(card => {
        const header = card.querySelector('.key-card-header');
        header.addEventListener('click', () => {
          const keyId = card.dataset.key;
          card.classList.toggle('expanded');
          
          if (!card.classList.contains('explored')) {
            card.classList.add('explored');
            explored.phase3.add(keyId);
            checkPhaseCompletion(3);
          }
        });
      });
    }

    function checkPhaseCompletion(phase) {
      const phaseKey = `phase${phase}`;
      const btn = document.getElementById(`btn-phase${phase}`);
      
      if (required[phaseKey].every(item => explored[phaseKey].has(item))) {
        btn.disabled = false;
        btn.onclick = () => goToPhase(phase + 1);
      }
    }

    function goToPhase(phase) {
      // Update phases
      document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));
      document.getElementById(`phase${phase}`).classList.add('active');
      
      // Update progress bar
      document.querySelectorAll('.progress-step').forEach(step => {
        const stepPhase = parseInt(step.dataset.phase);
        step.classList.remove('active', 'completed');
        if (stepPhase < phase) {
          step.classList.add('completed');
        } else if (stepPhase === phase) {
          step.classList.add('active');
        }
      });
      
      currentPhase = phase;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Quiz verification
    function verifyQuiz() {
      const questions = document.querySelectorAll('.quiz-question');
      let unanswered = [];
      let correct = 0;
      let total = questions.length;
      
      // Category tracking
      const categoryResults = {
        'somma-differenza': { correct: 0, total: 0 },
        'multiplo-sottomultiplo': { correct: 0, total: 0 },
        'congruenza': { correct: 0, total: 0 }
      };
      
      questions.forEach(q => {
        const qId = q.dataset.question;
        const correctAnswer = q.dataset.correct;
        const selected = document.querySelector(`input[name="${qId}"]:checked`);
        const category = q.closest('.quiz-category').dataset.category;
        
        categoryResults[category].total++;
        
        if (!selected) {
          unanswered.push(qId);
          return;
        }
        
        const feedback = q.querySelector('.feedback');
        const options = q.querySelectorAll('.option-label');
        
        // Disable all options
        options.forEach(opt => opt.classList.add('disabled'));
        
        if (selected.value === correctAnswer) {
          selected.closest('.option-label').classList.add('correct');
          feedback.classList.add('correct');
          correct++;
          categoryResults[category].correct++;
          quizResults[qId] = true;
        } else {
          selected.closest('.option-label').classList.add('incorrect');
          // Show correct answer
          options.forEach(opt => {
            if (opt.querySelector('input').value === correctAnswer) {
              opt.classList.add('correct');
            }
          });
          feedback.classList.add('incorrect');
          quizResults[qId] = false;
        }
      });
      
      // Check for unanswered
      if (unanswered.length > 0) {
        const warning = document.getElementById('missing-warning');
        warning.style.display = 'block';
        // Scroll to first unanswered
        const firstUnanswered = document.querySelector(`[data-question="${unanswered[0]}"]`);
        firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      
      document.getElementById('missing-warning').style.display = 'none';
      
      // Hide verify button, show continue button
      document.getElementById('btn-verify').style.display = 'none';
      document.getElementById('btn-phase4').style.display = 'inline-flex';
      document.getElementById('btn-phase4').onclick = () => {
        generateReview(correct, total, categoryResults);
        goToPhase(5);
      };
    }

    function generateReview(correct, total, categoryResults) {
      document.getElementById('final-score').textContent = `${correct}/${total}`;
      
      const reviewContent = document.getElementById('review-content');
      reviewContent.innerHTML = '';
      
      // Review data
      const reviewData = {
        'somma-differenza': {
          title: 'Somma e Differenza di Segmenti',
          needsReview: `
            <p><strong>Somma:</strong> La somma di due segmenti si ottiene disponendoli consecutivamente. La lunghezza del risultato √® la somma delle lunghezze.</p>
            <div class="formula-box"><span class="math">\\overline{EF} = \\overline{AB} + \\overline{CD}</span></div>
            <p><strong>Differenza:</strong> La differenza si pu√≤ calcolare solo se il primo segmento √® maggiore del secondo.</p>
            <div class="formula-box"><span class="math">\\overline{EF} = \\overline{AB} - \\overline{CD}</span> (con <span class="math">\\overline{AB} > \\overline{CD}</span>)</div>
          `,
          mastered: `<p>Hai capito bene come calcolare somma e differenza di segmenti. Ricorda: la differenza richiede che il primo segmento sia maggiore del secondo.</p>`
        },
        'multiplo-sottomultiplo': {
          title: 'Multiplo e Sottomultiplo',
          needsReview: `
            <p><strong>Multiplo:</strong> Il multiplo di un segmento si ottiene ripetendolo n volte.</p>
            <div class="formula-box"><span class="math">\\overline{CD} = n \\cdot \\overline{AB}</span></div>
            <p><strong>Sottomultiplo:</strong> Per calcolare una frazione di un segmento: prima dividi per il denominatore, poi moltiplichi per il numeratore.</p>
            <div class="formula-box"><span class="math">\\overline{CD} = \\frac{m}{n} \\cdot \\overline{AB} = \\overline{AB} : n \\cdot m</span></div>
          `,
          mastered: `<p>Ottimo lavoro sui multipli e sottomultipli! Ricorda la sequenza: prima dividere per il denominatore, poi moltiplicare per il numeratore.</p>`
        },
        'congruenza': {
          title: 'Congruenza e Confronto',
          needsReview: `
            <p>Due segmenti sono <strong>congruenti</strong> (simbolo ‚âÖ) quando hanno la stessa lunghezza.</p>
            <p>Attenzione: essere congruenti non significa essere nella stessa posizione! Due segmenti congruenti possono trovarsi in punti diversi del piano.</p>
          `,
          mastered: `<p>Hai compreso il concetto di congruenza: stessa lunghezza, non necessariamente stessa posizione.</p>`
        }
      };
      
      // Generate review sections
      for (const [category, results] of Object.entries(categoryResults)) {
        const data = reviewData[category];
        const isMastered = results.correct === results.total;
        
        const section = document.createElement('div');
        section.className = `review-area ${isMastered ? 'mastered' : 'needs-review'}`;
        section.innerHTML = `
          <div class="review-area-header">
            <span class="review-badge ${isMastered ? 'mastered' : 'needs-review'}">
              ${isMastered ? '‚úì Hai capito bene' : '‚ö† Da rivedere'}
            </span>
            <h4>${data.title}</h4>
          </div>
          <div class="review-content">
            ${isMastered ? data.mastered : data.needsReview}
          </div>
        `;
        reviewContent.appendChild(section);
      }
      
      // Re-render math in review
      renderMath();
    }

    function restart() {
      // Reset state
      explored.phase1.clear();
      explored.phase2.clear();
      explored.phase3.clear();
      quizResults = {};
      
      // Reset UI
      document.querySelectorAll('.concept-card').forEach(card => {
        card.classList.remove('expanded', 'explored');
      });
      document.querySelectorAll('.key-card').forEach(card => {
        card.classList.remove('expanded', 'explored');
      });
      document.querySelectorAll('.option-label').forEach(opt => {
        opt.classList.remove('correct', 'incorrect', 'disabled');
        opt.querySelector('input').checked = false;
      });
      document.querySelectorAll('.feedback').forEach(fb => {
        fb.classList.remove('correct', 'incorrect');
      });
      
      // Reset buttons
      ['btn-phase1', 'btn-phase2', 'btn-phase3'].forEach(id => {
        document.getElementById(id).disabled = true;
      });
      document.getElementById('btn-verify').style.display = 'inline-flex';
      document.getElementById('btn-phase4').style.display = 'none';
      document.getElementById('missing-warning').style.display = 'none';
      
      goToPhase(1);
    }
  </script>
</body>
</html>
