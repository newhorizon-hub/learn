<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Potenze con i Numeri Relativi - Percorso Didattico</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body, {delimiters: [{left: '$', right: '$', display: false}]});"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 1.8em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .progress-bar { display: flex; justify-content: center; gap: 10px; padding: 20px; background: #f8f9fa; flex-wrap: wrap; }
        .progress-step { width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666; transition: all 0.3s; }
        .progress-step.active { background: #eb3349; color: white; transform: scale(1.1); }
        .progress-step.completed { background: #27ae60; color: white; }
        .phase { display: none; padding: 30px; }
        .phase.active { display: block; }
        .phase-title { font-size: 1.4em; color: #333; margin-bottom: 10px; }
        .phase-subtitle { color: #666; margin-bottom: 20px; }
        .card-counter { background: #fce4ec; padding: 10px 15px; border-radius: 10px; margin-bottom: 20px; color: #c2185b; font-weight: 500; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: linear-gradient(145deg, #f5f7fa 0%, #e8ecf1 100%); border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .card.viewed { border-color: #eb3349; background: linear-gradient(145deg, #fce4ec 0%, #f8bbd9 100%); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-title { font-weight: bold; color: #333; font-size: 1.05em; }
        .card-check { color: #eb3349; font-size: 1.3em; opacity: 0; transition: opacity 0.3s; }
        .card.viewed .card-check { opacity: 1; }
        .card-hint { color: #888; font-size: 0.85em; }
        .card-content { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; color: #444; line-height: 1.7; }
        .card.expanded .card-content { display: block; }
        .card.expanded .card-hint { display: none; }
        .formula-box { background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px 15px; margin: 10px 0; border-radius: 0 8px 8px 0; font-family: 'Courier New', monospace; font-size: 1.1em; }
        .example-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px 15px; margin: 10px 0; border-radius: 0 8px 8px 0; }
        .warning-box { background: #ffebee; border-left: 4px solid #f44336; padding: 12px 15px; margin: 10px 0; border-radius: 0 8px 8px 0; }
        .positive { color: #27ae60; font-weight: bold; }
        .negative { color: #e74c3c; font-weight: bold; }
        .accordion { margin-bottom: 10px; border-radius: 10px; overflow: hidden; border: 1px solid #e0e0e0; }
        .accordion-header { background: #f5f7fa; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-header:hover { background: #e8ecf1; }
        .accordion.viewed .accordion-header { background: #fce4ec; }
        .accordion-title { font-weight: 600; color: #333; }
        .accordion-icon { transition: transform 0.3s; }
        .accordion.expanded .accordion-icon { transform: rotate(180deg); }
        .accordion-content { display: none; padding: 20px; background: white; line-height: 1.7; }
        .accordion.expanded .accordion-content { display: block; }
        .quiz-question { background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .quiz-question h3 { color: #333; margin-bottom: 15px; font-size: 1.05em; }
        .quiz-options { display: flex; flex-direction: column; gap: 10px; }
        .quiz-option { padding: 12px 15px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .quiz-option:hover:not(.disabled) { border-color: #eb3349; background: #fce4ec; }
        .quiz-option.selected { border-color: #eb3349; background: #f8bbd9; }
        .quiz-option.correct { border-color: #27ae60; background: #e8f5e9; }
        .quiz-option.wrong { border-color: #e74c3c; background: #ffebee; }
        .quiz-option.disabled { pointer-events: none; }
        .feedback { padding: 10px 15px; border-radius: 8px; margin-top: 10px; display: none; }
        .feedback.show { display: block; }
        .feedback.correct { background: #e8f5e9; color: #2e7d32; }
        .feedback.wrong { background: #ffebee; color: #c62828; }
        .category-header { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; padding: 10px 15px; border-radius: 10px; margin: 20px 0 15px 0; font-weight: 600; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 25px; flex-wrap: wrap; gap: 10px; }
        .btn { padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(235,51,73,0.4); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #d0d0d0; }
        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; }
        .score-display { text-align: center; padding: 30px; background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); border-radius: 15px; color: white; margin-bottom: 25px; }
        .score { font-size: 3em; font-weight: bold; }
        .score-label { font-size: 1.1em; opacity: 0.9; }
        .review-section { background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 15px; }
        .review-section h3 { color: #333; margin-bottom: 10px; }
        .review-section.mastered { border-left: 4px solid #27ae60; }
        .review-section.needs-review { border-left: 4px solid #ff9800; }
        .wrong-item { margin-top: 10px; padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #e74c3c; }
        @media print { body { background: white; } .container { box-shadow: none; } .header, .progress-bar, .nav-buttons { display: none; } .phase { display: none !important; } #phase5 { display: block !important; } }
        @media (max-width: 600px) { .header h1 { font-size: 1.4em; } .phase { padding: 20px; } .cards-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¢ Le Potenze con i Numeri Relativi</h1>
            <p>La Regola dei Segni e i Casi Particolari</p>
        </div>
        <div class="progress-bar">
            <div class="progress-step active">1</div>
            <div class="progress-step">2</div>
            <div class="progress-step">3</div>
            <div class="progress-step">4</div>
            <div class="progress-step">5</div>
        </div>

        <!-- FASE 1: La Regola Fondamentale -->
        <div id="phase1" class="phase active">
            <div class="phase-title">üìò Fase 1: La Regola Fondamentale dei Segni</div>
            <div class="phase-subtitle">Clicca su ogni card per scoprire come funzionano i segni</div>
            <div class="card-counter">Card visualizzate: <span id="counter1">0</span>/2</div>
            <div class="cards-grid">
                <div class="card" data-card="1">
                    <div class="card-header"><span class="card-title">Base POSITIVA</span><span class="card-check">‚úì</span></div>
                    <div class="card-hint">Clicca per espandere</div>
                    <div class="card-content">
                        Questa √® facile: il risultato √® <strong>SEMPRE POSITIVO</strong>!<br><br>
                        Non importa se l'esponente √® pari o dispari.
                        <div class="example-box">
                            $(+2)^2 = (+2) \times (+2) = $ <span class="positive">+4</span><br>
                            $(+2)^3 = (+2) \times (+2) \times (+2) = $ <span class="positive">+8</span>
                        </div>
                    </div>
                </div>
                <div class="card" data-card="2">
                    <div class="card-header"><span class="card-title">Base NEGATIVA</span><span class="card-check">‚úì</span></div>
                    <div class="card-hint">Clicca per espandere</div>
                    <div class="card-content">
                        Qui dovete fare attenzione! Guardate l'esponente.
                        <div class="formula-box">
                            Esponente PARI ‚Üí <span class="positive">POSITIVO</span><br>
                            Esponente DISPARI ‚Üí <span class="negative">NEGATIVO</span>
                        </div>
                        <strong>Perch√©?</strong><br>
                        ‚Ä¢ Pari: i segni "meno" si annullano a coppie<br>
                        ‚Ä¢ Dispari: rimane un "meno" da solo
                        <div class="example-box">
                            $(-2)^2 = (-2) \times (-2) = $ <span class="positive">+4</span><br>
                            $(-2)^3 = (-2) \times (-2) \times (-2) = $ <span class="negative">‚àí8</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-buttons">
                <div></div>
                <button class="btn btn-primary" id="next1" disabled>Prosegui ‚Üí</button>
            </div>
        </div>

        <!-- FASE 2: I Casi Particolari -->
        <div id="phase2" class="phase">
            <div class="phase-title">üìó Fase 2: I Casi Particolari</div>
            <div class="phase-subtitle">Clicca su ogni card per approfondire</div>
            <div class="card-counter">Card visualizzate: <span id="counter2">0</span>/3</div>
            <div class="cards-grid">
                <div class="card" data-card="3">
                    <div class="card-header"><span class="card-title">Esponente ZERO</span><span class="card-check">‚úì</span></div>
                    <div class="card-hint">Clicca per espandere</div>
                    <div class="card-content">
                        Qualsiasi numero (positivo o negativo) elevato a 0 fa sempre <strong>+1</strong>.
                        <div class="formula-box">a‚Å∞ = 1 (se a ‚â† 0)</div>
                        <div class="example-box">
                            $5^0 = 1$<br>
                            $(-3)^0 = +1$<br>
                            $(+100)^0 = 1$
                        </div>
                    </div>
                </div>
                <div class="card" data-card="4">
                    <div class="card-header"><span class="card-title">Esponente UNO</span><span class="card-check">‚úì</span></div>
                    <div class="card-hint">Clicca per espandere</div>
                    <div class="card-content">
                        Qualsiasi numero elevato a 1 rimane <strong>uguale a se stesso</strong> (mantiene il suo segno).
                        <div class="formula-box">a¬π = a</div>
                        <div class="example-box">
                            $(+3)^1 = +3$<br>
                            $(-3)^1 = -3$<br>
                            $(+7)^1 = +7$
                        </div>
                    </div>
                </div>
                <div class="card" data-card="5">
                    <div class="card-header"><span class="card-title">Esponente NEGATIVO</span><span class="card-check">‚úì</span></div>
                    <div class="card-hint">Clicca per espandere</div>
                    <div class="card-content">
                        L'esponente negativo <strong>NON fa diventare il risultato negativo</strong>!<br><br>
                        Il suo compito √® <strong>CAPOVOLGERE</strong> la base (fare il reciproco).
                        <div class="formula-box">a‚Åª‚Åø = (1/a)‚Åø</div>
                        <div class="example-box">
                            $3^{-2} = (1/3)^2 = 1/9$<br>
                            $(-2)^{-3} = (-1/2)^3 = -1/8$
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goToPhase(1)">‚Üê Indietro</button>
                <button class="btn btn-primary" id="next2" disabled>Prosegui ‚Üí</button>
            </div>
        </div>

        <!-- FASE 3: Gli Errori Comuni -->
        <div id="phase3" class="phase">
            <div class="phase-title">üìô Fase 3: Attenzione agli Errori Comuni!</div>
            <div class="phase-subtitle">Espandi ogni sezione per non cadere nelle trappole</div>
            <div class="card-counter">Sezioni visualizzate: <span id="counter3">0</span>/2</div>

            <div class="accordion" data-acc="1">
                <div class="accordion-header"><span class="accordion-title">‚ö†Ô∏è Errore 1: La PARENTESI √® fondamentale!</span><span class="accordion-icon">‚ñº</span></div>
                <div class="accordion-content">
                    <div class="warning-box">
                        <strong>$(-5)^2$ √® DIVERSO da $-5^2$</strong>
                    </div>
                    <br>
                    <strong>CON parentesi:</strong> $(-5)^2 = (-5) \times (-5) = $ <span class="positive">+25</span><br>
                    <small>La base √® $-5$, l'esponente √® pari ‚Üí positivo</small>
                    <br><br>
                    <strong>SENZA parentesi:</strong> $-5^2 = -(5 \times 5) = $ <span class="negative">‚àí25</span><br>
                    <small>La base √® $5$, il "meno" √® fuori dalla potenza e aspetta il risultato</small>
                </div>
            </div>
            <div class="accordion" data-acc="2">
                <div class="accordion-header"><span class="accordion-title">‚ö†Ô∏è Errore 2: L'Esponente NEGATIVO non cambia il segno!</span><span class="accordion-icon">‚ñº</span></div>
                <div class="accordion-content">
                    <div class="warning-box">
                        <strong>$4^{-2}$ NON FA $-16$ oppure $-8$</strong>
                    </div>
                    <br>
                    <strong>Ricorda:</strong> l'esponente negativo <strong>CAPOVOLGE</strong> la base!
                    <br><br>
                    <span class="negative">‚ùå SBAGLIATO:</span> $4^{-2} = -16$<br><br>
                    <span class="positive">‚úì CORRETTO:</span> $4^{-2} = (1/4)^2 = 1/16$
                </div>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goToPhase(2)">‚Üê Indietro</button>
                <button class="btn btn-primary" id="next3" disabled>Vai alla Verifica ‚Üí</button>
            </div>
        </div>

        <!-- FASE 4: Verifica -->
        <div id="phase4" class="phase">
            <div class="phase-title">üìù Fase 4: Verifica delle Conoscenze</div>
            <div class="phase-subtitle">Rispondi a tutte le domande, poi clicca "Verifica Risposte"</div>
            <div id="quiz-container"></div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goToPhase(3)">‚Üê Indietro</button>
                <button class="btn btn-success" id="verifyBtn" onclick="verifyQuiz()">‚úì Verifica Risposte</button>
            </div>
        </div>

        <!-- FASE 5: Ripasso -->
        <div id="phase5" class="phase">
            <div class="phase-title">üìä Fase 5: Ripasso Personalizzato</div>
            <div class="phase-subtitle">Riepilogo basato sui tuoi risultati</div>
            <div class="score-display">
                <div class="score"><span id="finalScore">0</span>/10</div>
                <div class="score-label">Risposte corrette</div>
            </div>
            <div id="review-container"></div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goToPhase(4)">‚Üê Rivedi Errori</button>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Stampa Ripasso</button>
            </div>
        </div>
    </div>

    <script>
        const quizData = [
            { category: "Regola dei Segni", question: "Quanto fa (+3)‚Å¥?", options: ["+81", "‚àí81", "+12", "‚àí12"], correct: 0, explanation: "Base positiva ‚Üí il risultato √® sempre positivo: (+3)‚Å¥ = +81" },
            { category: "Regola dei Segni", question: "Quanto fa (‚àí2)‚Å¥?", options: ["+16", "‚àí16", "+8", "‚àí8"], correct: 0, explanation: "Base negativa, esponente pari (4) ‚Üí risultato positivo: +16" },
            { category: "Regola dei Segni", question: "Quanto fa (‚àí2)¬≥?", options: ["+8", "‚àí8", "+6", "‚àí6"], correct: 1, explanation: "Base negativa, esponente dispari (3) ‚Üí risultato negativo: ‚àí8" },
            { category: "Regola dei Segni", question: "Quanto fa (‚àí1)¬π‚Å∞‚Å∞?", options: ["+1", "‚àí1", "+100", "‚àí100"], correct: 0, explanation: "100 √® pari ‚Üí (‚àí1)¬π‚Å∞‚Å∞ = +1" },
            { category: "Casi Particolari", question: "Quanto vale (‚àí7)‚Å∞?", options: ["0", "+1", "‚àí1", "‚àí7"], correct: 1, explanation: "Qualsiasi numero (‚â†0) elevato a 0 d√† sempre +1" },
            { category: "Casi Particolari", question: "Quanto vale (‚àí5)¬π?", options: ["+5", "‚àí5", "+1", "‚àí1"], correct: 1, explanation: "Qualsiasi numero elevato a 1 resta uguale a se stesso: (‚àí5)¬π = ‚àí5" },
            { category: "Casi Particolari", question: "Quanto vale 2‚Åª¬≥?", options: ["‚àí8", "‚àí6", "1/8", "8"], correct: 2, explanation: "Esponente negativo capovolge: 2‚Åª¬≥ = (1/2)¬≥ = 1/8" },
            { category: "Errori Comuni", question: "Qual √® la differenza tra (‚àí5)¬≤ e ‚àí5¬≤?", options: ["Nessuna, sono uguali", "(‚àí5)¬≤ = +25 e ‚àí5¬≤ = ‚àí25", "(‚àí5)¬≤ = ‚àí25 e ‚àí5¬≤ = +25", "Entrambi danno ‚àí25"], correct: 1, explanation: "Con parentesi: (‚àí5)¬≤ = +25. Senza: ‚àí5¬≤ = ‚àí(5¬≤) = ‚àí25" },
            { category: "Errori Comuni", question: "Quanto fa 4‚Åª¬≤?", options: ["‚àí16", "‚àí8", "1/16", "‚àí1/16"], correct: 2, explanation: "L'esponente negativo capovolge la base: 4‚Åª¬≤ = (1/4)¬≤ = 1/16 (positivo!)" },
            { category: "Errori Comuni", question: "Quanto fa (‚àí3)‚Åª¬≤?", options: ["‚àí9", "+9", "‚àí1/9", "+1/9"], correct: 3, explanation: "(‚àí3)‚Åª¬≤ = (‚àí1/3)¬≤ = +1/9 (esp. pari ‚Üí positivo)" }
        ];

        let viewedCards = { 1: new Set(), 2: new Set(), 3: new Set() };
        let selectedAnswers = {};
        let quizVerified = false;
        let categoryScores = { 
            'Regola dei Segni': { correct: 0, total: 4 }, 
            'Casi Particolari': { correct: 0, total: 3 },
            'Errori Comuni': { correct: 0, total: 3 }
        };

        function initCards() {
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('click', () => {
                    card.classList.toggle('expanded');
                    if (!card.classList.contains('viewed')) {
                        card.classList.add('viewed');
                        const cardNum = parseInt(card.dataset.card);
                        const phase = cardNum <= 2 ? 1 : 2;
                        viewedCards[phase].add(cardNum);
                        updateCounter(phase);
                    }
                    if (typeof renderMathInElement !== 'undefined') {
                        renderMathInElement(card, {delimiters: [{left: '$', right: '$', display: false}]});
                    }
                });
            });
        }

        function initAccordions() {
            document.querySelectorAll('.accordion').forEach(acc => {
                acc.querySelector('.accordion-header').addEventListener('click', () => {
                    acc.classList.toggle('expanded');
                    if (!acc.classList.contains('viewed')) {
                        acc.classList.add('viewed');
                        viewedCards[3].add(parseInt(acc.dataset.acc));
                        updateCounter(3);
                    }
                    if (typeof renderMathInElement !== 'undefined') {
                        renderMathInElement(acc, {delimiters: [{left: '$', right: '$', display: false}]});
                    }
                });
            });
        }

        function updateCounter(phase) {
            const total = phase === 1 ? 2 : phase === 2 ? 3 : 2;
            document.getElementById(`counter${phase}`).textContent = viewedCards[phase].size;
            const nextBtn = document.getElementById(`next${phase}`);
            if (viewedCards[phase].size >= total) {
                nextBtn.disabled = false;
                nextBtn.onclick = () => goToPhase(phase + 1);
            }
        }

        function initQuiz() {
            const container = document.getElementById('quiz-container');
            let currentCat = '';
            quizData.forEach((q, idx) => {
                if (q.category !== currentCat) {
                    currentCat = q.category;
                    container.innerHTML += `<div class="category-header">${currentCat}</div>`;
                }
                container.innerHTML += `
                    <div class="quiz-question" data-q="${idx}">
                        <h3>${idx + 1}. ${q.question}</h3>
                        <div class="quiz-options">${q.options.map((o, i) => `<div class="quiz-option" data-opt="${i}">${o}</div>`).join('')}</div>
                        <div class="feedback" id="fb-${idx}"></div>
                    </div>`;
            });
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    if (quizVerified) return;
                    const q = opt.closest('.quiz-question');
                    q.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedAnswers[q.dataset.q] = parseInt(opt.dataset.opt);
                });
            });
        }

        function verifyQuiz() {
            const unanswered = quizData.filter((_, i) => selectedAnswers[i] === undefined);
            if (unanswered.length > 0) { alert(`Devi rispondere a tutte le domande! Ne mancano ${unanswered.length}.`); return; }
            quizVerified = true;
            let correct = 0;
            Object.keys(categoryScores).forEach(c => categoryScores[c].correct = 0);
            quizData.forEach((q, idx) => {
                const qEl = document.querySelector(`[data-q="${idx}"]`);
                const opts = qEl.querySelectorAll('.quiz-option');
                const fb = document.getElementById(`fb-${idx}`);
                opts.forEach(o => o.classList.add('disabled'));
                const selOpt = qEl.querySelector(`[data-opt="${selectedAnswers[idx]}"]`);
                const corrOpt = qEl.querySelector(`[data-opt="${q.correct}"]`);
                if (selectedAnswers[idx] === q.correct) {
                    correct++; categoryScores[q.category].correct++;
                    selOpt.classList.add('correct');
                    fb.className = 'feedback show correct'; fb.textContent = '‚úì Corretto! ' + q.explanation;
                } else {
                    selOpt.classList.add('wrong'); corrOpt.classList.add('correct');
                    fb.className = 'feedback show wrong'; fb.textContent = '‚úó Sbagliato. ' + q.explanation;
                }
            });
            document.getElementById('finalScore').textContent = correct;
            document.getElementById('verifyBtn').textContent = 'Vai al Ripasso ‚Üí';
            document.getElementById('verifyBtn').onclick = () => goToPhase(5);
            generateReview();
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.getElementById('quiz-container'), {delimiters: [{left: '$', right: '$', display: false}]});
            }
        }

        function generateReview() {
            const container = document.getElementById('review-container');
            container.innerHTML = '';
            const wrongByCat = {};
            quizData.forEach((q, idx) => {
                if (selectedAnswers[idx] !== q.correct) {
                    if (!wrongByCat[q.category]) wrongByCat[q.category] = [];
                    wrongByCat[q.category].push({ question: q.question, yours: q.options[selectedAnswers[idx]], correct: q.options[q.correct], expl: q.explanation });
                }
            });
            
            const reviewContent = {
                'Regola dei Segni': '<ul style="margin:10px 0 0 20px;line-height:1.8;"><li>Base <strong>positiva</strong> ‚Üí sempre positivo</li><li>Base negativa + esp. <strong>pari</strong> ‚Üí positivo</li><li>Base negativa + esp. <strong>dispari</strong> ‚Üí negativo</li></ul>',
                'Casi Particolari': '<ul style="margin:10px 0 0 20px;line-height:1.8;"><li>a‚Å∞ = 1 (qualsiasi a ‚â† 0)</li><li>a¬π = a</li><li>a‚Åª‚Åø = (1/a)‚Åø (capovolgi!)</li></ul>',
                'Errori Comuni': '<ul style="margin:10px 0 0 20px;line-height:1.8;"><li>(‚àí5)¬≤ ‚â† ‚àí5¬≤ (le parentesi contano!)</li><li>L\'esponente negativo <strong>capovolge</strong>, non cambia segno</li></ul>'
            };
            
            for (const [cat, data] of Object.entries(categoryScores)) {
                const threshold = cat === 'Regola dei Segni' ? 3 : 2;
                const mastered = data.correct >= threshold;
                let html = `<div class="review-section ${mastered ? 'mastered' : 'needs-review'}">
                    <h3>${mastered ? '‚úì Hai capito bene' : '‚ö† Da rivedere'}: ${cat}</h3>
                    <p><strong>Punteggio:</strong> ${data.correct}/${data.total}</p>`;
                if (mastered) {
                    html += `<p>Ottimo lavoro su questa sezione!</p>`;
                } else {
                    html += `<p><strong>Ricorda:</strong></p>${reviewContent[cat]}`;
                }
                if (wrongByCat[cat]) {
                    html += `<div style="margin-top:15px;"><strong>üìã Le tue risposte errate:</strong>`;
                    wrongByCat[cat].forEach(w => {
                        html += `<div class="wrong-item"><p><strong>Domanda:</strong> ${w.question}</p><p style="color:#e74c3c;">‚ùå Tua risposta: ${w.yours}</p><p style="color:#27ae60;">‚úì Risposta corretta: ${w.correct}</p><p style="font-size:0.9em;color:#666;">${w.expl}</p></div>`;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
                container.innerHTML += html;
            }
        }

        function goToPhase(phase) {
            document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));
            document.getElementById(`phase${phase}`).classList.add('active');
            document.querySelectorAll('.progress-step').forEach((s, i) => {
                s.classList.remove('active');
                if (i + 1 < phase) s.classList.add('completed');
                if (i + 1 === phase) s.classList.add('active');
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => {
                if (typeof renderMathInElement !== 'undefined') {
                    renderMathInElement(document.getElementById(`phase${phase}`), {delimiters: [{left: '$', right: '$', display: false}]});
                }
            }, 50);
        }

        document.addEventListener('DOMContentLoaded', () => { 
            initCards(); 
            initAccordions(); 
            initQuiz(); 
            setTimeout(() => {
                if (typeof renderMathInElement !== 'undefined') {
                    renderMathInElement(document.body, {delimiters: [{left: '$', right: '$', display: false}]});
                }
            }, 100);
        });
    </script>
</body>
</html>
